name: Test Scripts

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-scripts:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq coreutils
    
    - name: Make scripts executable
      run: |
        chmod +x plugins/claude-code-quality-gate/scripts/*.sh
        chmod +x tests/*.sh
    
    - name: Test common-config.sh syntax
      run: bash -n plugins/claude-code-quality-gate/scripts/common-config.sh
    
    - name: Test quality-gate-stop.sh syntax
      run: bash -n plugins/claude-code-quality-gate/scripts/quality-gate-stop.sh
    
    - name: Test quality-gate-pre-commit.sh syntax
      run: bash -n plugins/claude-code-quality-gate/scripts/quality-gate-pre-commit.sh
    
    - name: Test quality-gate-status.sh syntax
      run: bash -n plugins/claude-code-quality-gate/scripts/quality-gate-status.sh
    
    - name: Run comprehensive function tests
      run: ./tests/test-functions.sh
    
    - name: Run quality gate integration tests
      run: ./tests/test-quality-gate-integration.sh
      if: always()
    
    - name: Run edge case tests
      run: ./tests/test-edge-cases.sh
      if: always()
    
    - name: Run quality-gate-status tests
      run: ./tests/test-quality-gate-status.sh
      if: always()
    
    - name: Run reverse command tests  
      run: ./tests/test-reverse-command.sh
      if: always()
    
    - name: Run edit tool detection tests
      run: ./tests/test-edit-tool.sh
      if: always()
    
    - name: Run user approve tests
      run: ./tests/test-user-approve.sh
      if: always()
    
    - name: Run JSON escaping tests
      run: ./tests/test-json-escaping.sh
      if: always()
    
    - name: Test script dependencies
      run: |
        echo "Checking script dependencies..."
        for script in plugins/claude-code-quality-gate/scripts/*.sh; do
          echo "Checking $script..."
          grep -E "command -v|which" "$script" | grep -oE "(jq|git|rg|gh)" | sort -u || true
        done
